name: Test Slack webhook

on:
  push:
    branches:
      - throwaway-testing-2

permissions:
  pull-requests: read

jobs:
  fake-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: 'npm'

      - name: Get Current Pull Request
        uses: 8BitJonny/gh-get-current-pr@3.0.0
        id: PR

      - name: Notify Success
        if: success()
        env:
          pkg: viz-components
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL_TESTING }}
          pr_title: ${{ steps.PR.outputs.pr_title }}
          pr_url: ${{ steps.PR.outputs.pr_url }}
        run: |
          export version=$(node -p "require('./projects/$pkg/package.json').version")
          curl -X POST -H "Content-type: application/json" --data "{\"text\": \"$pkg v${{ env.version }} (<$pr_url|$pr_title>) has been released\"}" $SLACK_WEBHOOK_URL
