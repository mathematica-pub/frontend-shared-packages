<div
  class="hsi-ui-listbox-container"
  [id]="service.id + '-listbox'"
  role="listbox"
  tabindex="-1"
  [class.open]="service.isOpen$ | async"
  [style.--max-reveal-height.px]="maxHeight"
  [attr.aria-labelledby]="
    (service.label$ | async) ? service.comboboxLabelId : label?.id
  "
  [attr.aria-multiselectable]="isMultiSelect"
>
  <div class="hsi-ui-listbox-scroll-container" [id]="service.scrollContainerId">
    <div class="hsi-ui-listbox-scrollable-content" #scrollContent>
      <ng-container
        *ngTemplateOutlet="label?.labelContent || nullContent"
      ></ng-container>
      <ng-container *ngIf="(groups$ | async)?.length > 0; else listbox">
        <ng-container *ngTemplateOutlet="listboxGroups"></ng-container>
      </ng-container>
    </div>
  </div>
</div>

<ng-template #listbox>
  @for (option of allOptions$ | async; track option.id; let i = $index) {
    <div
      role="option"
      class="hsi-ui-listbox-option"
      [ngClass]="'listbox-option-' + i"
      data-cy="listbox-option"
      [id]="service.id + '-listbox-option-' + i"
      [attr.aria-selected]="(option.selected$ | async) || false"
      [class.selected]="option.selected$ | async"
      [class.disabled]="option.disabled$ | async"
      [class.multi]="isMultiSelect"
      [class.current]="
        (activeIndex.activeIndex$ | async) === i &&
        (option.disabled$ | async) !== true
      "
      (click)="handleOptionClick($event, i)"
      (mousedown)="handleOptionMousedown()"
    >
      <ng-container *ngTemplateOutlet="option.template"></ng-container>
    </div>
  }
</ng-template>

<ng-template #listboxGroups>
  @for (group of groups$ | async; track $index; let i = $index) {
    <div class="hsi-ui-listbox-group-container">
      <div
        class="hsi-ui-listbox-group"
        [ngClass]="'listbox-group-' + i"
        role="group"
        [attr.aria-labelledby]="group.label?.id"
      >
        @if (group.label) {
          <div
            class="hsi-ui-listbox-group-label"
            [ngClass]="'hsi-ui-listbox-group-' + i + '-label'"
            role="presentation"
            [id]="group.label?.id"
          >
            <ng-container
              *ngTemplateOutlet="group.label?.labelContent || nullContent"
            ></ng-container
          ></div>
        }
        @for (
          option of group.options$ | async;
          track option.id;
          let j = $index
        ) {
          <div
            role="option"
            class="hsi-ui-listbox-option"
            [ngClass]="
              'hsi-ui-listbox-option-' + getOptionIndexFromGroups(i, j)
            "
            [id]="
              service.id + '-listbox-option-' + getOptionIndexFromGroups(i, j)
            "
            [attr.aria-selected]="(option.selected$ | async) || false"
            [class.selected]="option.selected$ | async"
            [class.multi]="isMultiSelect"
            [class.disabled]="option.disabled$ | async"
            [class.current]="
              (activeIndex.activeIndex$ | async) ===
              getOptionIndexFromGroups(i, j)
            "
            (click)="handleOptionClick($event, j, i)"
            (mousedown)="handleOptionMousedown()"
          >
            <ng-container *ngTemplateOutlet="option.template"></ng-container>
          </div>
        }
      </div>
    </div>
  }
</ng-template>
<ng-template #nullContent></ng-template>
