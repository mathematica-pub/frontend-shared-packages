AWSTemplateFormatVersion: '2010-09-09'
Description: 'AWS Codepipeline for the build and deploy a serverless app; utilizing a GitHub monorepo triggering with a WebHook off a desired branch.'

###############################################################################
# Metadata
###############################################################################

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: 'Application / Environment / Admin / Stack Reference(s)'
        Parameters:
          - Environment
          - ApplicationName
          - OperatorEmail
          - ManualApprovalForDeploy

      - Label:
          default: 'GitHub Repo Integration'
        Parameters:
          - GitHubRepository
          - SecretName
          - PercyToken

      - Label:
          default: 'Permission Boundary'
        Parameters:
          - PermissionBoundaryRequired
          - PermissionBoundarPolicyName

      - Label:
          default: 'Encryption'
        Parameters:
          - UseKmsEncryption
          - KmsKeyArn

      - Label:
          default: 'Build Configuration'
        Parameters:
          - TestAndBuildBuildSpecLoc
          - TestAndBuildImage
          - BackendBuildSpecLoc
          - DeployImage
          - DeployBuildSpecLoc

      - Label:
          default: 'Deployment Constance'
        Parameters:
          - DevS3WebsiteDeployBucket
          - DevCloudFrontDistributionId
          - ReleaseS3WebsiteDeployBucket
          - ReleaseCloudFrontDistributionId

      - Label:
          default: 'Resource Sizing'
        Parameters:
          - ArchiveAssetsBuildSpec
          - BuildInstanceSize
          - DeployInstanceSize
          - ArchiveInstanceSize

      - Label:
          default: 'VPC/Networking'
        Parameters:
          - ConfigureForVpc
          - VpcId
          - DatabaseSubnets
          - MprVpnSecurityGroup

      - Label:
          default: 'Cross Account Deployment Configs'
        Parameters:
          - StgDeploymentRoleArn
          - ProdDeploymentRoleArn
          
###############################################################################
# Parameters
###############################################################################

Parameters:
  ApplicationName:
    Type: String

  Environment:
    Description: Environment
    Type: String

  ArchiveAssetsBuildSpec:
    Type: String
    Description: Buildspec file (and location) for artifact archiving.
    Default: _archive-assets.yml

  GitHubRepository:
    Type: String
    Description: e.g. owner/repository/branch

  UseKmsEncryption:
    Description: 'Use KMS Encryption?'
    Type: String
    Default: true
    AllowedValues: [true, false]

  KmsKeyArn:
    Type: String
    Description: KMS Key for encrypting artifacts while at rest.

  SecretName:
    Type: String
    Description: Secrets Manager Secret with GitHub service account credentials
    Default: GitHub-Service-Account-Creds

  DevS3WebsiteDeployBucket:
      Type: String
      Description: The name of the Dev S3 bucket configured for static website hosting, to deploy front end solution to.

  DevCloudFrontDistributionId:
    Type: String
    Description: CloudFront Distribution Id to create invalidation for during front end deployment.
  
  ReleaseS3WebsiteDeployBucket:
      Type: String
      Description: The name of the Release S3 bucket configured for static website hosting, to deploy front end solution to.

  ReleaseCloudFrontDistributionId:
    Type: String
    Description: CloudFront Distribution Id to create invalidation for during front end deployment.

  PermissionBoundaryRequired:
    Description: 'Permission Boundary required?'
    Type: String
    Default: true
    AllowedValues: [true, false]

  PermissionBoundarPolicyName:
    Type: String
    Description: Permission Boundary Policy Document to reference when creating roles.
    Default: 'Math-Boundary-Policy'

  TestAndBuildBuildSpecLoc:
    Type: String
    Default: _buildspec.yml
    Description: Buildspec file (and location) for  build process.
  
  BackendBuildSpecLoc:
    Type: String
    Default: _buildspec.yml
    Description: Buildspec file (and location) for build process.

  DeployBuildSpecLoc:
    Type: String
    Default: _deploy_buildspec.yml
    Description: Buildspec file (and location) for  deploy process.

  OperatorEmail:
    Type: String
    Default: 'skirk@mathematica-mpr.com'
    Description: Initial email address for subscription request for SNS topic(s) for Pipeline.

  BuildInstanceSize:
    Type: String
    AllowedValues:
      - BUILD_GENERAL1_SMALL
      - BUILD_GENERAL1_MEDIUM
      - BUILD_GENERAL1_LARGE
    Description: Build Step Compute Size
    Default: BUILD_GENERAL1_LARGE

  DeployInstanceSize:
    Type: String
    AllowedValues:
      - BUILD_GENERAL1_SMALL
      - BUILD_GENERAL1_MEDIUM
      - BUILD_GENERAL1_LARGE
    Description: Deploy Step Compute Size
    Default: BUILD_GENERAL1_MEDIUM

  ArchiveInstanceSize:
    Type: String
    AllowedValues:
      - BUILD_GENERAL1_SMALL
      - BUILD_GENERAL1_MEDIUM
      - BUILD_GENERAL1_LARGE
    Description: Archive Step Compute Size
    Default: BUILD_GENERAL1_SMALL

  TestAndBuildImage:
    Type: String
    Default: 'aws/codebuild/amazonlinux2-x86_64-standard:4.0'
    Description: Back end Deploy image to use for CodeBuild project.

  DeployImage:
    Type: String
    Default: 'aws/codebuild/amazonlinux2-x86_64-standard:4.0'
    Description: Back end Deploy image to use for CodeBuild project.

  ManualApprovalForDeploy:
    Type: String
    Default: true
    AllowedValues: [true, false]

  MprVpnSecurityGroup:
    Type: String
    Description: Security Group that allow ingress to your RDS instance subnet

  DatabaseSubnets:
    Description: The subnets to place database instances in.
    Type: String

  VpcId:
    Description: VpcId
    Type: String

  ConfigureForVpc:
    Type: String
    Default: false
    AllowedValues: [true, false]


  StgDeploymentRoleArn:
    Description: The Arn of the Staging deployment role (CodeBuild) to grant s3:GetObject Access to on pipeline bucket
    Type: String

  ProdDeploymentRoleArn:
    Description: The Arn of the PROD deployment role (CodeBuild) to grant s3:GetObject Access to on pipeline bucket
    Type: String

  ServerlessConfig:
    Description: name of config to be used in the serverless process
    Type: String
  
  PercyToken: 
    Description: percy token
    Type: String

###############################################################################
# Conditions
###############################################################################

Conditions:
  UsePermissionBoundary: !Equals [true, !Ref PermissionBoundaryRequired]

  UseKmsEncryptionForArtifacts: !Equals [true, !Ref UseKmsEncryption]

  RequireManualApprovalForDeployment: !Equals [true, !Ref ManualApprovalForDeploy]

  DeployInVpc: !Equals [true, !Ref ConfigureForVpc]

###############################################################################
# Resources
###############################################################################

Resources:
  DeployedSourceVersionParameter:
    Type: AWS::SSM::Parameter
    Properties:
      DataType: text
      Description: 'Last sucessful deploy source'
      Type: String
      Value: '<null>'
      Name: !Sub '/${ApplicationName}/dev/latest-success-build/source-version'

  DevDeployedSourceVersionParameter:
    Type: AWS::SSM::Parameter
    Properties:
      DataType: text
      Description: 'Last sucessful Dev deploy source'
      Type: String
      Value: '<null>'
      Name: !Sub '/${ApplicationName}/dev/latest-success-release/source-version'

  LatestDeployAssetsParameter:
    Type: AWS::SSM::Parameter
    Properties:
      DataType: text
      Description: 'Last deployed assets'
      Type: String
      Value: '<null>'
      Name: !Sub '/${ApplicationName}/dev/latest-deployed'

  CodePipelineTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub '${ApplicationName}-${Environment}-pipeline-event'
      KmsMasterKeyId: !Ref KmsKeyArn
      Subscription:
        - Endpoint: !Ref OperatorEmail
          Protocol: 'email'

  CodePipelineRawEventTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub '${ApplicationName}-${Environment}-raw-pipeline-events'
      KmsMasterKeyId: !Ref KmsKeyArn
      Subscription:
        - Endpoint: !Ref OperatorEmail
          Protocol: 'email'

  ManualApprovalTopic:
    Condition: RequireManualApprovalForDeployment
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub '${ApplicationName}-${Environment}-pipeline-manual-approval'
      KmsMasterKeyId: !Ref KmsKeyArn
      Subscription:
        - Endpoint: !Ref OperatorEmail
          Protocol: 'email'

  ManualApprovalTopicPolicy:
    Condition: RequireManualApprovalForDeployment
    Type: AWS::SNS::TopicPolicy
    Properties:
      Topics:
        - !Ref CodePipelineTopic
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: '*'
            Action: sns:Publish
            Resource: !Ref ManualApprovalTopic

  CodePipelineTopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Properties:
      Topics:
        - !Ref CodePipelineTopic
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: '*'
            Action: sns:Publish
            Resource: !Ref CodePipelineTopic

  CodePipelineRawEventTopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Properties:
      Topics:
        - !Ref CodePipelineRawEventTopic
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: '*'
            Action: sns:Publish
            Resource: !Ref CodePipelineRawEventTopic

  PublishToSnsTopicPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub 'MathPolicy-SnsTopicPublish-${ApplicationName}-${Environment}'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          Effect: Allow
          Action:
            - sns:Publish
          Resource:
            - !Ref CodePipelineTopic
      Roles:
        - !Ref CodePipelineRole
        - !Ref CodeBuildRole

  PublishToRawSnsTopicPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub 'MathPolicy-SnsRawTopicPublish-${ApplicationName}-${Environment}'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          Effect: Allow
          Action:
            - sns:Publish
          Resource:
            - !Ref CodePipelineRawEventTopic
      Roles:
        - !Ref CodePipelineRole
        - !Ref CodeBuildRole

  PublishToManualApprovalSnsTopicPolicy:
    Condition: RequireManualApprovalForDeployment
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub 'MathPolicy-SnsManualApproval-${ApplicationName}-${Environment}'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          Effect: Allow
          Action:
            - sns:Publish
          Resource:
            - !Ref ManualApprovalTopic
      Roles:
        - !Ref CodePipelineRole
        - !Ref CodeBuildRole

  PipelineFailedEventRule:
    Type: 'AWS::Events::Rule'
    Properties:
      Description: !Sub '${ApplicationName}-${Environment}-pipeline-failed'
      EventPattern:
        source:
          - aws.codepipeline
        detail-type:
          - CodePipeline Pipeline Execution State Change
        detail:
          state:
            - 'FAILED'
          pipeline:
            - !Ref Pipeline
      State: 'ENABLED'
      Targets:
        - Arn:
            Ref: CodePipelineRawEventTopic
          Id: 'CodePipelineRawEventTopic-Topic'
        - Arn:
            Ref: CodePipelineTopic
          Id: 'CodePipelineHumanReadableTopic'
          InputTransformer:
            InputPathsMap:
              pipeline: '$.detail.pipeline'
            InputTemplate: |
              "Pipeline <pipeline> - has failed!"
  PipelineSucceededEventRule:
    Type: 'AWS::Events::Rule'
    Properties:
      Description: !Sub '${ApplicationName}-${Environment}-pipeline-success'
      EventPattern:
        source:
          - aws.codepipeline
        detail-type:
          - CodePipeline Pipeline Execution State Change
        detail:
          state:
            - 'SUCCEEDED'
          pipeline:
            - !Ref Pipeline
      State: 'ENABLED'
      Targets:
        - Arn:
            Ref: CodePipelineRawEventTopic
          Id: 'CodePipelineRawEventTopic-Topic'
        - Arn:
            Ref: CodePipelineTopic
          Id: 'CodePipeline-Topic'
          InputTransformer:
            InputPathsMap:
              pipeline: '$.detail.pipeline'
            InputTemplate: |
              "Pipeline <pipeline> - completed and deployed sucessfully!"
  CodeBuildProjectFailEvent:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub '${ApplicationName}-${Environment}-Pipeline-CodeBuild-FAIL-Event'
      Description: !Sub '${ApplicationName} ${Environment} CodePipeline CodeBuild Project FAIL Event'
      EventPattern:
        source:
          - aws.codebuild
        detail-type:
          - 'CodeBuild Build State Change'
        detail:
          build-status:
            - 'FAILED'
          project-name:
            - !Ref TestAndBuild
            - !Ref DevDeploy
            - !Ref ReleaseDeploy
            - !Ref ArchiveArtifacts
      State: 'ENABLED'
      Targets:
        - Arn:
            Ref: CodePipelineRawEventTopic
          Id: 'CodePipelineRawEventTopic-Topic'
        - Arn:
            Ref: CodePipelineTopic
          Id: 'CodePipeline-Topic'
          InputTransformer:
            InputPathsMap:
              build-id: '$.detail.build-id'
              build-project-name: '$.detail.project-name'
              build-status: '$.detail.build-status'
              pipeline: '$.detail.additional-information.initiator'
            InputTemplate: |
              "CodeBuild Project <build-project-name> of <pipeline> has FAILED!"
  CodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'MathRole-CodeBuild-${ApplicationName}-${Environment}'
      PermissionsBoundary:
        !If [UsePermissionBoundary, !Sub 'arn:aws:iam::${AWS::AccountId}:policy/${PermissionBoundarPolicyName}', !Ref AWS::NoValue]
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          Effect: 'Allow'
          Principal:
            Service:
              - 'codebuild.amazonaws.com'
              - 'cloudformation.amazonaws.com'
          Action: 'sts:AssumeRole'

  CodePipelineRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'MathRole-CodePipeline-${ApplicationName}-${Environment}'
      PermissionsBoundary:
        !If [UsePermissionBoundary, !Sub 'arn:aws:iam::${AWS::AccountId}:policy/${PermissionBoundarPolicyName}', !Ref AWS::NoValue]
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          Effect: Allow
          Principal:
            Service:
              - codepipeline.amazonaws.com
          Action: 'sts:AssumeRole'

  EncryptDecryptWithKmsPolicy:
    Condition: UseKmsEncryptionForArtifacts
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyName: !Sub 'MathPolicy-EncryptDecryptWithKms-${ApplicationName}-${Environment}'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          Effect: Allow
          Action:
            - kms:RetireGrant
            - kms:CreateGrant
            - kms:ReEncrypt*
            - kms:GenerateDataKey*
            - kms:Encrypt
            - kms:DescribeKey
            - kms:Decrypt
          Resource: !Ref KmsKeyArn
      Roles:
        - !Ref CodeBuildRole
        - !Ref CodePipelineRole
  VpcAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub 'MathPolicy-VPCAccess-${ApplicationName}-vpc-pipeline-runner-${Environment}'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          Effect: Allow
          Action:
            - ec2:DescribeDhcpOptions
            - ec2:CreateNetworkInterface
            - ec2:CreateNetworkInterfacePermission
            - ec2:DescribeNetworkInterfaces
            - ec2:DeleteNetworkInterface
            - ec2:DescribeSubnets
            - ec2:DescribeSecurityGroups
            - ec2:DescribeVpcs
          Resource: '*'
      Roles:
        - !Ref CodeBuildRole

  CodeBuildPolicy:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyName: !Sub 'MathPolicy-CodeBuild-${ApplicationName}-${Environment}'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          Effect: Allow
          Action:
            - s3:*
            - logs:*
            - codebuild:*
            - cloudfront:*
            - ssm:GetParameter
            - ssm:DescribeParameters
            - ssm:PutParameter
            - ssm:GetParameters
            - ssm:AddTagsToResource
            - cloudformation:List*
            - cloudformation:Get*
            - cloudformation:PreviewStackUpdate
            - cloudformation:ValidateTemplate
            - cloudformation:CreateStack
            - cloudformation:CreateUploadBucket
            - cloudformation:DeleteStack
            - cloudformation:DeleteChangeSet
            - cloudformation:Describe*
            - cloudformation:UpdateStack
            - lambda:Get*
            - lambda:List*
            - lambda:CreateFunction
            - lambda:AddPermission
            - lambda:CreateAlias
            - lambda:DeleteFunction
            - lambda:InvokeFunction
            - lambda:PublishVersion
            - lambda:RemovePermission
            - lambda:Update*
            - apigateway:GET
            - apigateway:POST
            - apigateway:PUT
            - apigateway:DELETE
            - iam:PassRole
            - iam:GetRole
            - iam:CreateRole
            - iam:PutRolePolicy
            - iam:DeleteRolePolicy
            - iam:DeleteRole
            - iam:DetachRolePolicy
            - iam:UpdateAssumeRolePolicy
            - iam:UpdateAssumeRolePolicyDocument
            - iam:ListAttachedRolePolicies
            - iam:DeleteRole
            - cloudwatch:GetMetricStatistics
            - events:Put*
            - events:Remove*
            - events:Delete*
            - sns:ListTopics
            - sns:Publish
            - states:CreateStateMachine
            - states:DeleteStateMachine
            - states:TagResource
            - states:UpdateStateMachine
            - states:StartExecution
            - states:DescribeExecution
            - states:GetExecutionHistory
          Resource: '*'
      Roles:
        - !Ref CodeBuildRole

  ServerlessAgentPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub 'MathPolicy-ServerlessAgent-${ApplicationName}-${Environment}'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          Effect: Allow
          Action:
            - secretsmanager:*
            - apigateway:*
            - lambda:*
            - s3:*
            - s3:PutBucketAcl
            - ec2:*
            - ssm:*
            - cloudformation:CancelUpdateStack
            - cloudformation:ContinueUpdateRollback
            - cloudformation:CreateChangeSet
            - cloudformation:CreateStack
            - cloudformation:CreateUploadBucket
            - cloudformation:DeleteStack
            - cloudformation:DeleteChangeSet
            - cloudformation:Describe*
            - cloudformation:EstimateTemplateCost
            - cloudformation:ExecuteChangeSet
            - cloudformation:Get*
            - cloudformation:List*
            - cloudformation:PreviewStackUpdate
            - cloudformation:UpdateStack
            - cloudformation:UpdateTerminationProtection
            - cloudformation:ValidateTemplate
            - events:DeleteRule
            - events:DescribeRule
            - events:ListRuleNamesByTarget
            - events:ListRules
            - events:ListTargetsByRule
            - events:PutRule
            - events:PutTargets
            - events:RemoveTargets
            - iam:CreateServiceLinkedRole
            - iam:CreateRole
            - iam:DeleteRole
            - iam:DeleteRolePolicy
            - iam:GetRole
            - iam:GetRolePolicy
            - iam:PassRole
            - iam:PutRolePolicy
            - iam:AttachRolePolicy
            - iam:DetachRolePolicy
            - iam:UpdateAssumeRolePolicy
            - iam:UpdateAssumeRolePolicyDocument
            - iam:ListAttachedRolePolicies
            - iam:DeleteRole
            - logs:CreateLogGroup
            - logs:DeleteLogGroup
            - logs:DescribeLogGroups
            - logs:DescribeLogStreams
            - logs:FilterLogEvents
            - logs:GetLogEvents
            - sns:CreateTopic
            - sns:DeleteTopic
            - sns:GetSubscriptionAttributes
            - sns:GetTopicAttributes
            - sns:ListSubscriptions
            - sns:ListSubscriptionsByTopic
            - sns:ListTopics
            - sns:SetSubscriptionAttributes
            - sns:SetTopicAttributes
            - sns:Subscribe
            - sns:Unsubscribe
          Resource: '*'
      Roles:
        - !Ref CodeBuildRole

  CodePipelinePolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub 'MathPolicy-CodePipelinePolicy-${ApplicationName}-${Environment}'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            - s3:PutObject
            - s3:GetObject
            - codebuild:*
            - iam:PassRole
          Resource:
            - '*'
      Roles:
        - !Ref CodePipelineRole

  PipelineArtifactBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ApplicationName}-${Environment}-pipeline-artifacts'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  PipelineArtifactBucketPolicy:
    Type: AWS::S3::BucketPolicy
    DependsOn:
      - PipelineArtifactBucket
    Properties:
      Bucket: !Ref PipelineArtifactBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Principal: '*'
            Sid: 'AllowSSLRequestsOnly'
            Action: 's3:*'
            Effect: Deny
            Resource: !Sub '${PipelineArtifactBucket.Arn}/*'
            Condition:
              Bool:
                aws:SecureTransport: false
          # - Principal:
          #     AWS: 
          #       - !Ref StgDeploymentRoleArn
          #       - !Ref ProdDeploymentRoleArn
          #   Sid: PROD-GetObject-DeploymentArtifacts
          #   Action: s3:GetObject
          #   Effect: Allow
          #   Resource: !Sub '${PipelineArtifactBucket.Arn}/DeployedArtifcats/*'

  TestAndBuild:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub '${ApplicationName}-${Environment}-test-and-build'
      Description:  build w/ CodeBuild within CodePipeline
      ServiceRole: !Ref CodeBuildRole
      EncryptionKey: !If [UseKmsEncryptionForArtifacts, !Ref KmsKeyArn, !Ref AWS::NoValue]
      TimeoutInMinutes: 20
      VpcConfig:
        !If 
          - DeployInVpc
          - SecurityGroupIds: !Ref MprVpnSecurityGroup
            Subnets: !Ref DatabaseSubnets
            VpcId: !Ref VpcId
          - !Ref AWS::NoValue
      Source:
        Type: CODEPIPELINE
        BuildSpec: !Ref TestAndBuildBuildSpecLoc
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: !Ref BuildInstanceSize
        Image: !Ref DeployImage
        EnvironmentVariables:
          - Name: ENVTYPE
            Type: PLAINTEXT
            Value: dev
          - Name: SERVERLESS_CONFIG
            Type: PLAINTEXT
            Value: !Ref ServerlessConfig
      Artifacts:
        Type: CODEPIPELINE

  DevDeploy:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub '${ApplicationName}-${Environment}-deploy-dev'
      Description: 'Deploy Dev solution via Serverless Framework deployment.'
      ServiceRole: !Ref CodeBuildRole
      EncryptionKey: !If [UseKmsEncryptionForArtifacts, !Ref KmsKeyArn, !Ref AWS::NoValue]
      TimeoutInMinutes: 15
      Source:
        Type: CODEPIPELINE
        BuildSpec: !Ref DeployBuildSpecLoc
      Environment:
        Type: 'LINUX_CONTAINER'
        ComputeType: !Ref DeployInstanceSize
        Image: !Ref DeployImage
        EnvironmentVariables:
          - Name: ENVTYPE
            Type: PLAINTEXT
            Value: !Ref Environment
          - Name: APPNAME
            Type: PLAINTEXT
            Value: !Ref ApplicationName
          - Name: DeployedSourceVersionParameter
            Type: PLAINTEXT
            Value: !Ref DevDeployedSourceVersionParameter
          - Name: S3WebsiteDeployBucket
            Type: PLAINTEXT
            Value: !Ref DevS3WebsiteDeployBucket
          - Name: CloudFrontDistributionId
            Type: PLAINTEXT
            Value: !Ref DevCloudFrontDistributionId
          - Name: FrontEndBuildName
            Type: PLAINTEXT
            Value: !Ref TestAndBuild

      Artifacts:
        Type: CODEPIPELINE

  ReleaseDeploy:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub '${ApplicationName}-${Environment}-deploy-release'
      Description: 'Deploy Release solution via Serverless Framework deployment.'
      ServiceRole: !Ref CodeBuildRole
      EncryptionKey: !If [UseKmsEncryptionForArtifacts, !Ref KmsKeyArn, !Ref AWS::NoValue]
      TimeoutInMinutes: 15
      Source:
        Type: CODEPIPELINE
        BuildSpec: !Ref DeployBuildSpecLoc
      Environment:
        Type: 'LINUX_CONTAINER'
        ComputeType: !Ref DeployInstanceSize
        Image: !Ref DeployImage
        EnvironmentVariables:
          - Name: ENVTYPE
            Type: PLAINTEXT
            Value: release
          - Name: APPNAME
            Type: PLAINTEXT
            Value: !Ref ApplicationName
          - Name: DeployedSourceVersionParameter
            Type: PLAINTEXT
            Value: !Ref DeployedSourceVersionParameter
          - Name: S3WebsiteDeployBucket
            Type: PLAINTEXT
            Value: !Ref ReleaseS3WebsiteDeployBucket
          - Name: CloudFrontDistributionId
            Type: PLAINTEXT
            Value: !Ref ReleaseCloudFrontDistributionId
      Artifacts:
        Type: CODEPIPELINE


  ArchiveArtifacts:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub '${ApplicationName}-${Environment}-archive-assets'
      Description: Archive Assets w/ CodeBuild within CodePipeline.
      ServiceRole: !Ref CodeBuildRole
      EncryptionKey: !If [UseKmsEncryptionForArtifacts, !Ref KmsKeyArn, !Ref AWS::NoValue]
      TimeoutInMinutes: 15
      Source:
        Type: CODEPIPELINE
        BuildSpec: !Ref ArchiveAssetsBuildSpec
      Environment:
        Type: 'LINUX_CONTAINER'
        ComputeType: !Ref ArchiveInstanceSize
        Image: aws/codebuild/amazonlinux2-x86_64-standard:4.0
        EnvironmentVariables:
          - Name: PipelineBucket
            Type: PLAINTEXT
            Value: !Ref PipelineArtifactBucket
          - Name: ArtifactPrefix
            Type: PLAINTEXT
            Value: 'DeployedArtifcats'
          - Name: Environment
            Type: PLAINTEXT
            Value: !Ref Environment
          - Name: DeployedSourceVersionParameter
            Type: PLAINTEXT
            Value: !Ref DeployedSourceVersionParameter
          - Name: LatestDeployAssetsParameter
            Type: PLAINTEXT
            Value: !Ref LatestDeployAssetsParameter
      Artifacts:
        Type: CODEPIPELINE

  Pipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name: !Sub '${ApplicationName}-${Environment}-pipeline'
      ArtifactStore:
        Location: !Ref PipelineArtifactBucket
        Type: S3
      RestartExecutionOnUpdate: true
      RoleArn: !GetAtt CodePipelineRole.Arn
      Stages:

        # Stage 1:  Source from GitHub
        - Name: Source
          Actions:
            - Name: SourceAction
              RunOrder: 1
              ActionTypeId:
                Category: Source
                Owner: ThirdParty
                Provider: GitHub
                Version: 1
              Configuration:
                Owner: !Select [0, !Split ['/', !Ref GitHubRepository]]
                Repo: !Select [1, !Split ['/', !Ref GitHubRepository]]
                Branch: !Select [2, !Split ['/', !Ref GitHubRepository]]
                PollForSourceChanges: true
                OAuthToken: !Sub '{{resolve:secretsmanager:${SecretName}:SecretString:token}}'
              OutputArtifacts:
                - Name: SourceCodeFromGitHub
              Namespace: SourceActionVariables

        # Stage 2:  Build and Test
        - Name: TestAndBuild
          Actions:
            - Name: TestAndBuild
              RunOrder: 1
              InputArtifacts:
                - Name: SourceCodeFromGitHub
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: 1
              Configuration:
                ProjectName: !Ref TestAndBuild
                EnvironmentVariables:
                  Fn::Join:
                    - ''
                    - - '['
                      - '{ "name":"COMMIT_ID", "type":"PLAINTEXT", "value":"#{SourceActionVariables.CommitId}" },'
                      - '{ "name":"COMMIT_URL", "type":"PLAINTEXT", "value":"#{SourceActionVariables.CommitUrl}" },'
                      - '{ "name":"REPO_NAME", "type":"PLAINTEXT", "value":"#{SourceActionVariables.RepositoryName}" },'
                      - '{ "name":"BRANCH", "type":"PLAINTEXT", "value":"#{SourceActionVariables.BranchName}" },'
                      - '{ "name":"COMMIT_AUTHOR_DATE", "type":"PLAINTEXT", "value":"#{SourceActionVariables.AuthorDate}" },'
                      - '{ "name":"COMMIT_DATE", "type":"PLAINTEXT", "value":"#{SourceActionVariables.CommitterDate}" },'
                      - !Sub '{ "name":"PERCY_TOKEN", "type": "PLAINTEXT", "value": "${PercyToken}" }'
                      - ']'
              OutputArtifacts:
                - Name: TestAndBuildArtifacts
              Namespace: TestAndBuildVariables

        # # Stage 3: dev Deploy
        - Name: DevDeploy
          Actions:
            - Name: Deploy
              RunOrder: 1
              InputArtifacts:
                - Name: TestAndBuildArtifacts
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: 1
              Configuration:
                ProjectName: !Ref DevDeploy
                EnvironmentVariables:
                  Fn::Join:
                    - ''
                    - - '['
                      - '{ "name":"COMMIT_ID", "type":"PLAINTEXT", "value":"#{SourceActionVariables.CommitId}" },'
                      - '{ "name":"COMMIT_URL", "type":"PLAINTEXT", "value":"#{SourceActionVariables.CommitUrl}" },'
                      - '{ "name":"REPO_NAME", "type":"PLAINTEXT", "value":"#{SourceActionVariables.RepositoryName}" },'
                      - '{ "name":"BRANCH", "type":"PLAINTEXT", "value":"#{SourceActionVariables.BranchName}" },'
                      - '{ "name":"COMMIT_AUTHOR_DATE", "type":"PLAINTEXT", "value":"#{SourceActionVariables.AuthorDate}" },'
                      - '{ "name":"COMMIT_DATE", "type":"PLAINTEXT", "value":"#{SourceActionVariables.CommitterDate}" }'
                      - ']'
              OutputArtifacts:
                - Name: DevDeployArtifacts
              Namespace: DevDeployVariables

        - Name: ReleaseDeploy
          Actions:
            - !If
              - RequireManualApprovalForDeployment
              - Name: Approval-To-Deploy
                RunOrder: 1
                InputArtifacts: []
                OutputArtifacts: []
                ActionTypeId:
                  Category: Approval
                  Owner: AWS
                  Version: 1
                  Provider: Manual
                Configuration:
                  NotificationArn: !Ref ManualApprovalTopic
                  CustomData: !Sub 'Manual Approval Required For ${ApplicationName} Release Deployment'
              - !Ref AWS::NoValue

            # a. 
            - Name: ReleaseDeploy
              RunOrder: 2
              InputArtifacts:
                - Name: DevDeployArtifacts
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: 1
              Configuration:
                ProjectName: !Ref ReleaseDeploy
                EnvironmentVariables:
                  Fn::Join:
                    - ''
                    - - '['
                      - '{ "name":"COMMIT_ID", "type":"PLAINTEXT", "value":"#{SourceActionVariables.CommitId}" },'
                      - '{ "name":"COMMIT_URL", "type":"PLAINTEXT", "value":"#{SourceActionVariables.CommitUrl}" },'
                      - '{ "name":"REPO_NAME", "type":"PLAINTEXT", "value":"#{SourceActionVariables.RepositoryName}" },'
                      - '{ "name":"BRANCH", "type":"PLAINTEXT", "value":"#{SourceActionVariables.BranchName}" },'
                      - '{ "name":"COMMIT_AUTHOR_DATE", "type":"PLAINTEXT", "value":"#{SourceActionVariables.AuthorDate}" },'
                      - '{ "name":"COMMIT_DATE", "type":"PLAINTEXT", "value":"#{SourceActionVariables.CommitterDate}" }'
                      - ']'
              OutputArtifacts:
                - Name: DummyOutputArtifacts
              Namespace: DeployVariables

        # #Stage 4: Archive
        - Name: ArchiveAndTest
          Actions:
            - Name: ArchiveArtifacts
              RunOrder: 1
              InputArtifacts:
                - Name: DummyOutputArtifacts
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: 1
              Configuration:
                ProjectName: !Ref ArchiveArtifacts
                EnvironmentVariables:
                  Fn::Join:
                    - ''
                    - - '['
                      - '{ "name":"COMMIT_ID", "type":"PLAINTEXT", "value":"#{SourceActionVariables.CommitId}" },'
                      - '{ "name":"COMMIT_URL", "type":"PLAINTEXT", "value":"#{SourceActionVariables.CommitUrl}" },'
                      - '{ "name":"REPO_NAME", "type":"PLAINTEXT", "value":"#{SourceActionVariables.RepositoryName}" },'
                      - '{ "name":"BRANCH", "type":"PLAINTEXT", "value":"#{SourceActionVariables.BranchName}" },'
                      - '{ "name":"COMMIT_AUTHOR_DATE", "type":"PLAINTEXT", "value":"#{SourceActionVariables.AuthorDate}" },'
                      - '{ "name":"COMMIT_DATE", "type":"PLAINTEXT", "value":"#{SourceActionVariables.CommitterDate}" }'
                      - ']'

Outputs:
  Environment:
    Value: !Ref Environment
  GitHubConfig:
    Value: !Ref GitHubRepository
  Pipeline:
    Value: !Ref Pipeline
  DeployedSourceVersionParameter:
    Value: !Ref DeployedSourceVersionParameter
  DevDeployedSourceVersionParameter:
    Value: !Ref DevDeployedSourceVersionParameter
  LatestDeployAssetsParameter:
    Value: !Ref LatestDeployAssetsParameter
  CodePipelineTopic:
    Value: !Ref CodePipelineTopic
  CodePipelineRawEventTopic:
    Value: !Ref CodePipelineRawEventTopic
  CodeBuildRole:
    Value: !Ref CodeBuildRole
  CodePipelineRole:
    Value: !Ref CodePipelineRole
  PipelineArtifactBucket:
    Value: !Ref PipelineArtifactBucket
  PipelineFailedEventRule:
    Value: !Ref PipelineFailedEventRule
  PipelineSucceededEventRule:
    Value: !Ref PipelineSucceededEventRule
  CodeBuildProjectFailEvent:
    Value: !Ref CodeBuildProjectFailEvent